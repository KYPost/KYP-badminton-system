<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0,
    maximum-scale=1.0, user-scalable=no,viewport-fit=cover"
    />
    <title>ç¾½çƒåˆ†çµ„ç³»çµ±</title>
    <style>
      :root {
        --primary: #2c3e50;
        --accent: #3498db;
        --success: #27ae60;
        --danger: #e74c3c;
        --light: #f8f9fa;
        --warning: #f39c12;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        touch-action: manipulation;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 12px;
        font-size: 14px;
        color: #333;
      }
      .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }

      h1 {
        text-align: center;
        font-size: 1.6rem;
        margin: 10px 0 25px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      /* è¼¸å…¥ä»‹é¢æ¨£å¼ */
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
        padding: 15px;
        background: var(--light);
        border-radius: 10px;
        border: 1px solid #e1e4e8;
      }
      .row {
        display: flex;
        gap: 10px;
        width: 100%;
        align-items: center;
      }

      select,
      input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px !important;
        background: white;
      }

      .btn-back {
        background: #95a5a6;
        color: white;
        border: none;
        padding: 0 12px; /* çµ¦äºˆå·¦å³å…§è·è®“æ–‡å­—å‘¼å¸ */
        border-radius: 8px;
        cursor: pointer;
        height: 48px; /* é«˜åº¦èˆ‡è¼¸å…¥æ¡†ä¿æŒä¸€è‡´ */
        font-size: 10px; /* å­—é«”ç¨ç¸®å°ï¼Œæ›´ç²¾ç·» */
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap; /* å¼·åˆ¶æ–‡å­—ä¸æ›è¡Œ */
        flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è¢«è¼¸å…¥æ¡†æ“ å£“è®Šå½¢ */
      }
      .btn-add {
        background: var(--primary);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        font-weight: bold;
        transition: opacity 0.2s;
      }

      /* çƒå“¡æ¨™ç±¤èˆ‡å®¹å™¨ */
      .player-pool {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 10px;
        margin-bottom: 20px;
        min-height: 120px;
        max-height: 200px;
        overflow-y: auto;
      }
      /* çƒå“¡æ¨™ç±¤æ¨£å¼ */
      .tag {
        background: #f0f7ff;
        border: 1px solid #d1e9ff;
        padding: 6px 15px;
        border-radius: 8px; /* åŸç‚º 8pxï¼Œæ”¹ç‚º 4px æ¸›å°‘åœ“å¼§æ„Ÿ */
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.95rem;
      }
      .btn-del {
        color: var(--danger);
        background: none;
        border: none;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0 2px;
        line-height: 1; /* æ•¸å€¼å¯ä»¥æ ¹æ“šè¦–è¦ºå¾®èª¿ï¼Œä¾‹å¦‚ 1.2 ~ 1.5 */
        vertical-align: middle;
      }

      /* æ‰‹æ©Ÿç«¯æ’ç‰ˆé—œéµï¼šå‚ç›´åŒ–è¨­å®šå€ */
      .setting-row {
        display: flex;
        flex-direction: column; /* æ”¹ç‚ºå‚ç›´æ’åˆ—ï¼Œè§£æ±ºæ‰‹æ©Ÿé‡ç–Šå•é¡Œ */
        gap: 15px;
        margin-top: 15px;
        padding: 0 5px;
      }

      .setting-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .setting-group label {
        font-weight: bold;
        font-size: 0.95rem;
        color: #444;
      }

      .setting-group input {
        width: 100%; /* ç¢ºä¿è¼¸å…¥æ¡†å……æ»¿å¯¬åº¦ */
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
      }

      /* å ´åœ°å¡ç‰‡ç¾åŒ– */
      .court-card {
        background: #fbfdff;
        border: 1px solid #ddecff;
        border-top: 6px solid var(--accent);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.03);
      }
      .court-header {
        font-weight: bold;
        color: var(--accent);
        font-size: 1.1rem;
        margin-bottom: 15px;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 10px;
      }
      .match-display {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 15px;
        text-align: center;
        font-size: 1.2rem;
        margin: 15px 0;
      }
      .team b {
        color: var(--primary);
        display: block;
        line-height: 1.4;
      }
      .scorer-info {
        background: #fff9f0;
        border: 1px dashed var(--warning);
        padding: 10px;
        border-radius: 8px;
        font-size: 0.95rem;
        text-align: center;
        color: #856404;
        margin-top: 10px;
      }
      .btn-finish {
        background: var(--success);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 8px;
        width: 100%;
        font-weight: bold;
        cursor: pointer;
        margin-top: 15px;
        font-size: 1rem;
      }

      /* ä¼‘æ¯å€èˆ‡çµ±è¨ˆ */
      .rest-box {
        background: #fff3e0;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ffe0b2;
        margin-top: 25px;
      }
      .waiting-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
      }
      .waiting-tag {
        background: white;
        padding: 5px 10px;
        border-radius: 6px;
        border: 1px solid #ffd180;
        font-size: 0.9rem;
      }

      .stats-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }
      .stats-table th {
        background: #f8f9fa;
        color: #666;
        font-weight: 600;
        padding: 12px 5px;
        border-bottom: 2px solid #dee2e6;
      }
      .stats-table td {
        padding: 12px 5px;
        border: 1px solid #ddd;
        text-align: center;
        border-bottom: 1px solid #eee;
      }

      /* ç‹€æ…‹é¡è‰² */
      .status-on {
        color: var(--success);
        font-weight: bold;
      }
      .status-scoring {
        color: var(--warning);
        font-weight: bold;
      }
      .status-off {
        color: #abb5be;
      }

      .btn-start {
        background: var(--accent);
        width: 100%;
        padding: 18px;
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.2rem;
        margin-top: 10px;
        box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
      }
      .btn-reset {
        background: #f8f9fa;
        color: var(--danger);
        border: 1px solid var(--danger);
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        margin-top: 30px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="title">ğŸ¸ ç¾½çƒæ’å ´ç³»çµ±</h1>

      <div id="setupView">
        <details open>
          <summary style="font-weight: bold; cursor: pointer; padding: 5px 0">
            ğŸ‘¥ çƒå“¡ç®¡ç† (<span id="pCount">0</span>äºº)
          </summary>
          <div class="input-group">
            <div class="row">
              <select id="pSelect" onchange="toggleCustom(this)">
                <option value="">é¸æ“‡äººå“¡...</option>
                <option value="Apple">Apple</option>
                <option value="Bonnie">Bonnie</option>
                <option value="Chloe">Chloe</option>
                <option value="Jamie">Jamie</option>
                <option value="Momo">Momo</option>
                <option value="Nora">Nora</option>
                <option value="Nora (å®¤å‹)">Nora (å®¤å‹)</option>
                <option value="Reno">Reno</option>
                <option value="Richard">Richard</option>
                <option value="Sally">Sally</option>
                <option value="Sam">Sam</option>
                <option value="Sasha">Sasha</option>
                <option value="Vivian">Vivian</option>
                <option value="å°ç”«">å°ç”«</option>
                <option value="å°ç”«å‹ (è€æ›¹)">å°ç”«å‹ (è€æ›¹)</option>
                <option value="å°ç”«å‹ (é­šä¸¸)">å°ç”«å‹ (é­šä¸¸)</option>
                <option value="_custom_">å…¶ä»–äººå“¡ (æ‰‹å‹•è¼¸å…¥)</option>
              </select>
              <input
                type="text"
                id="cInput"
                placeholder="è«‹è¼¸å…¥å§“å"
                style="display: none"
              />
              <button
                id="backBtn"
                class="btn-back"
                style="display: none"
                onclick="resetUI()"
              >
                â† è¿”å›
              </button>
            </div>
            <button class="btn-add" onclick="addPlayer()">ï¼‹ åŠ å…¥åå–®</button>
          </div>

          <div class="player-pool" id="pPool"></div>

          <div class="setting-row">
            <div class="setting-group">
              <label for="courtQty">å ´åœ°æ•¸</label>
              <input type="number" id="courtQty" value="2" min="1" />
            </div>
            <div class="setting-group">
              <label for="maxOn">æœ€é«˜é€£çºŒä¸Šå ´æ¬¡æ•¸</label>
              <input type="number" id="maxOn" value="2" min="1" />
            </div>
          </div>
        </details>
        <button onclick="initSystem()" class="btn-start">
          ğŸš€ é–‹å§‹åˆ†çµ„æŠ½ç±¤
        </button>
      </div>

      <div id="mainView" style="display: none">
        <div id="courtsArea"></div>

        <div class="rest-box">
          <strong>â˜• ä¼‘æ¯åå–® (å„ªå…ˆä¸Šå ´æ’åº)ï¼š</strong>
          <div id="waitingArea" class="waiting-list"></div>
        </div>

        <table class="stats-table">
          <thead>
            <tr>
              <th>çƒå“¡</th>
              <th>å ´æ•¸</th>
              <th>é€£ä¸Š</th>
              <th>é€£ä¼‘</th>
              <th>ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody id="pStats"></tbody>
        </table>

        <button onclick="location.reload()" class="btn-reset">
          çµæŸæ´»å‹•ä¸¦é‡ç½®æ•¸æ“š
        </button>
      </div>
    </div>

    <script>
      let names = [
        "å°ç”«",
        "Richard",
        "Sasha",
        "Momo",
        "Nora",
        "Bonnie",
        "Apple",
        "Vivian",
        "Sam",
        "Reno",
        "Sally",
        "Chloe",
      ];
      let players = [];
      let courts = [];

      window.onload = () => updatePool();

      // --- UI è¼”åŠ©åŠŸèƒ½ ---
      function toggleCustom(s) {
        if (s.value === "_custom_") {
          s.style.display = "none";
          document.getElementById("cInput").style.display = "block";
          document.getElementById("backBtn").style.display = "block";
          document.getElementById("cInput").focus();
        }
      }

      function resetUI() {
        const s = document.getElementById("pSelect");
        s.style.display = "block";
        s.value = "";
        document.getElementById("cInput").style.display = "none";
        document.getElementById("backBtn").style.display = "none";
      }

      function addPlayer() {
        const sel = document.getElementById("pSelect");
        const inp = document.getElementById("cInput");
        let n = inp.style.display === "block" ? inp.value.trim() : sel.value;
        if (n && !names.includes(n)) {
          names.push(n);
          if (inp.style.display === "block") inp.value = "";
          updatePool();
        }
      }

      function delPlayer(n) {
        names = names.filter((i) => i !== n);
        updatePool();
      }

      function updatePool() {
        document.getElementById("pCount").innerText = names.length;
        const sortedNames = [...names].sort((a, b) =>
          a.localeCompare(b, "zh-Hans-TW")
        );
        document.getElementById("pPool").innerHTML = sortedNames
          .map(
            (n) =>
              `<div class="tag">${n}<button class="btn-del" onclick="delPlayer('${n}')">Ã—</button></div>`
          )
          .join("");
      }

      // --- æ ¸å¿ƒé‚è¼¯æ§åˆ¶ ---

      function initSystem() {
        const cQty = parseInt(document.getElementById("courtQty").value);
        if (names.length < 4 * cQty)
          return alert(`äººæ•¸ä¸è¶³ï¼${cQty} å€‹å ´åœ°è‡³å°‘éœ€è¦ ${4 * cQty} äºº`);

        players = names.map((n) => ({
          name: n,
          played: 0,
          onStreak: 0,
          restStreak: 0,
          status: "idle",
        }));

        courts = Array.from({ length: cQty }, (_, i) => ({
          id: i + 1,
          users: [],
        }));

        document.getElementById("setupView").style.display = "none";
        document.getElementById("mainView").style.display = "block";
        document.getElementById("title").innerText = "ğŸ¸ æ’å ´ç³»çµ±é‹ä½œä¸­";

        refreshAllCourts();
      }

      // é‚è¼¯ 2: å…¨å ´é‡æ–°æŠ½ç±¤ (é©ç”¨æ–¼ N <= 6n)
      function refreshAllCourts() {
        const cQty = courts.length;
        const totalPeople = players.length;

        // æ›´æ–°é€£æ‰“èˆ‡é€£ä¼‘ç‹€æ…‹
        players.forEach((p) => {
          if (p.status !== "idle") {
            p.onStreak++;
            p.restStreak = 0;
          } else {
            p.restStreak++;
            p.onStreak = 0;
          }
          p.status = "idle";
        });

        // æ’åºï¼šä¼‘æ¯æœ€ä¹… > å ´æ•¸æœ€å°‘ > éš¨æ©Ÿ
        let pool = [...players].sort(
          (a, b) =>
            b.restStreak - a.restStreak ||
            a.played - b.played ||
            Math.random() - 0.5
        );

        // é‚è¼¯ 1: åˆ¤å®šæ˜¯å¦éœ€è¦è¨ˆåˆ†å“¡ (N >= 5n å‰‡éœ€è¦)
        const needsScorer = totalPeople >= 5 * cQty;

        courts.forEach((court) => {
          let required = needsScorer ? 5 : 4;
          let selected = pool.splice(0, required);

          if (selected.length >= 4) {
            for (let i = 0; i < 4; i++) {
              selected[i].status = "playing";
              selected[i].played++;
            }
            if (needsScorer && selected[4]) {
              selected[4].status = "scoring";
              selected[4].onStreak = 0;
            }
            court.users = selected;
          }
        });
        render();
      }

      // å–®å ´çµæŸé‚è¼¯ (é©ç”¨æ–¼ N > 6n)
      function finishOneCourt(cId) {
        const court = courts.find((c) => c.id === cId);
        const maxOn = parseInt(document.getElementById("maxOn").value);

        // ç›®å‰æ²’åœ¨æ‰“çƒçš„äººé«”åŠ›æ¢å¾©(å¢åŠ é€£ä¼‘)
        players.forEach((p) => {
          if (p.status === "idle") p.restStreak++;
        });

        // å ´ä¸Šçš„äººä¸‹å ´
        court.users.forEach((p) => {
          p.status = "idle";
          p.onStreak = p.status === "playing" ? p.onStreak : 0;
        });

        // æŒ‘é¸æ–°äººï¼šè€ƒæ…®é€£æ‰“é™åˆ¶
        let available = players.filter(
          (p) => p.status === "idle" && p.onStreak < maxOn
        );
        if (available.length < 5)
          available = players.filter((p) => p.status === "idle");

        available.sort(
          (a, b) =>
            b.restStreak - a.restStreak ||
            a.played - b.played ||
            Math.random() - 0.5
        );

        // å–®å ´çµæŸé€šå¸¸äººæ•¸å¤šï¼Œå¿…æœ‰è¨ˆåˆ†å“¡
        let selected = available.slice(0, 5);
        selected.slice(0, 4).forEach((p) => {
          p.status = "playing";
          p.played++;
          p.onStreak++;
          p.restStreak = 0;
        });
        if (selected[4]) {
          selected[4].status = "scoring";
          selected[4].onStreak = 0;
        }

        court.users = selected;
        render();
      }

      function render() {
        const cQty = courts.length;
        const isWholeMode = names.length <= 6 * cQty; // é‚è¼¯ 2ï¼šåˆ¤æ–·å…¨å ´æ›çµ„æ¨¡å¼

        let html = courts
          .map((c) => {
            if (c.users.length < 4)
              return `<div class="court-card">ğŸ“ å ´åœ° ${c.id}<br>ç­‰å¾…åˆ†é…ä¸­...</div>`;

            const scorer = c.users[4];
            const scorerHtml =
              scorer && scorer.status === "scoring"
                ? `<div class="scorer-info">ğŸ“‹ è¨˜åˆ†å“¡ï¼š<strong>${scorer.name}</strong></div>`
                : `<div class="scorer-info" style="border-color:#ccc; color:#999;">ğŸš« æ­¤äººæ•¸è¦æ¨¡ä¸è¨­è¨˜åˆ†å“¡</div>`;

            const btnHtml = isWholeMode
              ? ""
              : `<button class="btn-finish" onclick="finishOneCourt(${c.id})">âœ… çµæŸæ­¤å ´ (æ›ä¸‹ä¸€çµ„)</button>`;

            return `
                <div class="court-card">
                    <div class="court-header">ğŸ“ å ´åœ° ${c.id} ${
              isWholeMode ? "(å…¨å ´æ›´æ›ä¸­)" : ""
            }</div>
                    <div class="match-display">
                        <div class="team"><b>${c.users[0].name}</b><b>${
              c.users[1].name
            }</b></div>
                        <div style="color:#aaa; font-style:italic; font-size:1rem;">VS</div>
                        <div class="team"><b>${c.users[2].name}</b><b>${
              c.users[3].name
            }</b></div>
                    </div>
                    ${scorerHtml}
                    ${btnHtml}
                </div>`;
          })
          .join("");

        if (isWholeMode) {
          html += `<button class="btn-start" style="background:var(--success); margin-bottom:20px;" onclick="refreshAllCourts()">ğŸ”„ å…¨å ´æ›çµ„ (ç•¶å‰äººæ•¸ï¼š${names.length})</button>`;
        }

        document.getElementById("courtsArea").innerHTML = html;

        // æ¸²æŸ“çµ±è¨ˆå€
        const waiters = players
          .filter((p) => p.status === "idle")
          .sort((a, b) => b.restStreak - a.restStreak);
        document.getElementById("waitingArea").innerHTML =
          waiters
            .map(
              (p) =>
                `<span class="waiting-tag">${p.name} <small>(ä¼‘${p.restStreak})</small></span>`
            )
            .join("") || "ç„¡";

        document.getElementById("pStats").innerHTML = players
          .map((p) => {
            let sText = "ä¼‘æ¯",
              sClass = "status-off";
            if (p.status === "playing") {
              sText = "ğŸ¸ ä¸Šå ´";
              sClass = "status-on";
            } else if (p.status === "scoring") {
              sText = "ğŸ“‹ è¨ˆåˆ†";
              sClass = "status-scoring";
            }
            return `<tr><td>${p.name}</td><td>${p.played}</td><td>${p.onStreak}</td><td>${p.restStreak}</td><td class="${sClass}">${sText}</td></tr>`;
          })
          .join("");
      }
    </script>
  </body>
</html>
