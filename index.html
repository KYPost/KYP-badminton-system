<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾½çƒæŠ½ç±¤åˆ†çµ„</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --light: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #eee;
            margin: 0;
            padding: 10px;
            font-size: 14px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        /* è¨­å®šå€èˆ‡æ·»åŠ ä»‹é¢ */
        details {
            background: var(--light);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }

        summary {
            font-weight: bold;
            cursor: pointer;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .add-player-ui {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            border: 1px dashed #ccc;
        }

        select,
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
        }

        .btn-add {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* çƒå“¡æ¨™ç±¤é¡¯ç¤ºå€ */
        .player-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: #fff;
            padding: 12px;
            border: 2px inset #eee;
            border-radius: 8px;
            max-height: 200px;
            /* é™åˆ¶é«˜åº¦ï¼Œé¿å…æ’é–‹æ•´å€‹ç•«é¢ */
            overflow-y: auto;
            /* éå¤šæ™‚é¡¯ç¤ºæ²è»¸ */
        }

        .player-tag {
            background: #f0f7ff;
            border: 1px solid #d1e9ff;
            padding: 8px 12px;
            /* åŠ å¤§å…§è·å¥½é»æ“Š */
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .btn-del {
            color: #fff;
            background: var(--danger);
            /* æ”¹ç”¨ç´…è‰²èƒŒæ™¯å¢åŠ è¾¨è­˜åº¦ */
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            line-height: 1;
            border: none;
            cursor: pointer;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .form-group {
            flex: 1;
            min-width: 120px;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* æŒ‰éˆ•å€ */
        .btn-group {
            display: flex;
            gap: 8px;
            margin: 15px 0;
        }

        button {
            flex: 1;
            padding: 12px 5px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            color: white;
        }

        .btn-start {
            background: var(--accent);
        }

        .btn-next {
            background: var(--success);
        }

        .btn-reset {
            background: var(--danger);
            font-size: 0.8rem;
            flex: 0.5;
        }

        /* å ´åœ°èˆ‡çµ±è¨ˆå…§å®¹ */
        .court-card {
            background: #e8f4fd;
            border-left: 5px solid var(--accent);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .court-title {
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 8px;
            border-bottom: 1px solid #bcd;
        }

        .match {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .team {
            flex: 1;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .vs {
            padding: 0 15px;
            color: #888;
            font-style: italic;
            font-weight: normal;
        }

        .rest-area {
            background: #fff3e0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ffe0b2;
        }

        .tag {
            display: inline-block;
            background: #fb8c00;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            margin: 2px;
            font-size: 0.85rem;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px 4px;
            text-align: center;
        }

        th {
            background: #f2f2f2;
        }

        .active-row {
            background: #e8f5e9;
            font-weight: bold;
        }

        .must-tag {
            color: red;
            font-size: 0.7rem;
            display: block;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ğŸ¸ ç¾½çƒæ’å ´</h1>

        <details open>
            <summary>ğŸ‘¥ çƒå“¡ç®¡ç† (<span id="playerCount">0</span>äºº)</summary>

            <div class="add-player-ui">
                <select id="playerSelect" onchange="handleSelectChange(this)">
                    <option value="">å¿«é€ŸåŠ å…¥å¸¸ç”¨...</option>
                    <option value="å°ç”«">å°ç”«</option>
                    <option value="å°ç”«å‹ï¼ˆé­šä¸¸ï¼‰">å°ç”«å‹ï¼ˆé­šä¸¸ï¼‰</option>
                    <option value="å°ç”«å‹ï¼ˆè€æ›¹ï¼‰">å°ç”«å‹ï¼ˆè€æ›¹ï¼‰</option>
                    <option value="Richard">Richard</option>
                    <option value="Sasha">Sasha</option>
                    <option value="MOMO">MOMO</option>
                    <option value="Nora">Nora</option>
                    <option value="Bonnie">Bonnie</option>
                    <option value="Apple">Apple</option>
                    <option value="Vivian">Vivian</option>
                    <option value="Nora(å®¤å‹)">Nora(å®¤å‹)</option>
                    <option value="Sam">Sam</option>
                    <option value="Reno">Reno</option>
                    <option value="Sally">Sally</option>
                    <option value="Chloe">Chloe</option>
                    <option value="_custom_">å…¶ä»–äººå“¡</option>
                </select>
                <input type="text" id="customInput" placeholder="è¼¸å…¥å§“å" style="display:none;">
                <button class="btn-add" onclick="addPlayer()">åŠ å…¥</button>
            </div>

            <div class="player-pool" id="playerPool"></div>

            <div class="form-row">
                <div class="form-group"><label>å ´åœ°æ•¸</label><input type="number" id="cNum" value="2"></div>
                <div class="form-group"><label>æœ€é«˜ä¼‘æ¯å ´æ•¸</label><input type="number" id="rLimit" value="2"></div>
            </div>
        </details>

        <div class="btn-group">
            <button class="btn-start" onclick="init()">é–‹å§‹/åˆå§‹åŒ–</button>
            <button class="btn-next" id="nextBtn" onclick="draw()" disabled>ä¸‹ä¸€å±€</button>
            <button class="btn-reset" onclick="location.reload()">é‡ç½®</button>
        </div>

        <div id="displayArea" style="display:none;">
            <h2 id="roundInfo" style="text-align:center; margin:10px 0;"></h2>
            <div id="courts"></div>
            <div class="rest-area" id="restPlayers"></div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>çƒå“¡</th>
                            <th>å ´æ¬¡</th>
                            <th>ä¼‘</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="stats"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let playerNames = ["å°ç”«", "Richard"]; // é è¨­åˆå§‹åå–®
        let players = [];
        let round = 0;

        // åˆå§‹åŒ–åå–®é¡¯ç¤º
        window.onload = () => renderPlayerPool();

        function handleSelectChange(sel) {
            const customInput = document.getElementById('customInput');
            if (sel.value === "_custom_") {
                customInput.style.display = "block";
            } else {
                customInput.style.display = "none";
            }
        }

        function addPlayer() {
            const sel = document.getElementById('playerSelect');
            const customInp = document.getElementById('customInput');
            let name = "";

            if (sel.value === "_custom_") {
                name = customInp.value.trim();
            } else if (sel.value !== "") {
                name = sel.value;
            }

            if (name && !playerNames.includes(name)) {
                playerNames.push(name);
                customInp.value = "";
                renderPlayerPool();
            } else if (playerNames.includes(name)) {
                alert("çƒå“¡å·²åœ¨åå–®ä¸­");
            }
        }

        function removePlayer(name) {
            playerNames = playerNames.filter(n => n !== name);
            renderPlayerPool();
        }

        function renderPlayerPool() {
            const pool = document.getElementById('playerPool');
            document.getElementById('playerCount').innerText = playerNames.length;
            pool.innerHTML = playerNames.map(name => `
            <div class="player-tag">
                ${name}
                <button class="btn-del" onclick="removePlayer('${name}')">Ã—</button>
            </div>
        `).join('');
        }

        function init() {
            if (playerNames.length === 0) return alert("è«‹å…ˆåŠ å…¥çƒå“¡");

            players = playerNames.map(n => ({
                name: n, played: 0, rest: 0, on: false
            }));

            const cNum = parseInt(document.getElementById('cNum').value);
            if (players.length < cNum * 4) return alert("äººæ•¸ä¸è¶³ï¼Œå ´åœ°éœ€ " + (cNum * 4) + " äºº");

            round = 0;
            document.getElementById('displayArea').style.display = 'block';
            document.getElementById('nextBtn').disabled = false;
            draw();
        }

        function draw() {
            round++;
            const cNum = parseInt(document.getElementById('cNum').value);
            const rLimit = parseInt(document.getElementById('rLimit').value);
            const need = cNum * 4;

            const maxP = Math.max(...players.map(p => p.played));
            players.forEach(p => {
                p.weight = 1 + 2 * (maxP - p.played) + 1 * p.rest;
            });

            let must = players.filter(p => p.rest >= rLimit);
            let others = players.filter(p => p.rest < rLimit);

            let selected = [];
            if (must.length >= need) {
                selected = must.sort(() => Math.random() - 0.5).slice(0, need);
            } else {
                selected = [...must];
                others.sort(() => Math.random() - 0.5);
                for (let i = selected.length; i < need; i++) {
                    let totalW = others.reduce((s, p) => s + p.weight, 0);
                    let r = Math.random() * totalW;
                    let sum = 0;
                    for (let j = 0; j < others.length; j++) {
                        sum += others[j].weight;
                        if (r <= sum) {
                            selected.push(others.splice(j, 1)[0]);
                            break;
                        }
                    }
                }
            }

            const names = selected.map(s => s.name);
            players.forEach(p => {
                if (names.includes(p.name)) {
                    p.played++; p.rest = 0; p.on = true;
                } else {
                    p.rest++; p.on = false;
                }
            });

            renderMatches(selected, cNum);
        }

        function renderMatches(selected, cNum) {
            document.getElementById('roundInfo').innerText = "ç¬¬ " + round + " å±€";
            const courtDiv = document.getElementById('courts');
            courtDiv.innerHTML = '';
            const shuffled = [...selected].sort(() => Math.random() - 0.5);

            for (let i = 0; i < cNum; i++) {
                const p = shuffled.slice(i * 4, i * 4 + 4);
                courtDiv.innerHTML += `
                <div class="court-card">
                    <div class="court-title">å ´åœ° ${i + 1}</div>
                    <div class="match">
                        <div class="team"><span>${p[0].name}</span><span>${p[1].name}</span></div>
                        <div class="vs">vs</div>
                        <div class="team"><span>${p[2].name}</span><span>${p[3].name}</span></div>
                    </div>
                </div>`;
            }

            const rests = players.filter(p => !p.on);
            document.getElementById('restPlayers').innerHTML = '<strong>â˜• ä¼‘æ¯ï¼š</strong>' +
                rests.map(p => `<span class="tag">${p.name}</span>`).join('');

            const tbody = document.getElementById('stats');
            tbody.innerHTML = '';
            [...players].sort((a, b) => a.played - b.played).forEach(p => {
                const rLimit = parseInt(document.getElementById('rLimit').value);
                tbody.innerHTML += `
                <tr class="${p.on ? 'active-row' : ''}">
                    <td>${p.name}</td>
                    <td>${p.played}</td>
                    <td>${p.rest}</td>
                    <td>${p.on ? 'ğŸ¸ä¸Šå ´' : (p.rest >= rLimit ? '<span class="must-tag">ğŸ”¥å¿…ä¸Š</span>' : 'ä¼‘')}</td>
                </tr>`;
            });
        }
    </script>
</body>

</html>
