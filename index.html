<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ç¾½çƒæ’å ´ç³»çµ± - ç•°æ­¥èª¿åº¦ç‰ˆ</title>
    <style>
      :root {
        --primary: #2c3e50;
        --accent: #3498db;
        --success: #27ae60;
        --danger: #e74c3c;
        --light: #f8f9fa;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #eee;
        margin: 0;
        padding: 10px;
        font-size: 14px;
        overflow-x: hidden;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      /* è¼¸å…¥ä»‹é¢æ¨£å¼ */
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
        padding: 12px;
        background: var(--light);
        border-radius: 8px;
        border: 1px dashed #ccc;
      }
      .row {
        display: flex;
        gap: 8px;
        width: 100%;
        align-items: center;
      }
      select,
      input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
        background: white;
      }

      /* 1. å„ªåŒ–è¿”å›æŒ‰éˆ•ï¼šåŠ å¤§ä¸”æ›´æ˜“é»æ“Š */
      .btn-back {
        background: #95a5a6;
        color: white;
        border: none;
        padding: 12px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        height: 46px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .btn-add {
        background: var(--primary);
        color: white;
        border: none;
        padding: 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        font-weight: bold;
      }

      /* çƒå“¡æ¨™ç±¤æ¨£å¼ */
      .player-pool {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 15px;
        min-height: 100px;
        max-height: 180px;
        overflow-y: auto;
      }
      .tag {
        background: #f0f7ff;
        border: 1px solid #d1e9ff;
        padding: 6px 10px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.95rem;
      }
      .btn-del {
        color: var(--danger);
        background: none;
        border: none;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.2rem;
      }

      /* 3. è¨­å®šå€å¡Šä½ˆå±€å„ªåŒ– */
      .setting-row {
        display: flex;
        gap: 15px;
        margin-top: 10px;
      }
      .setting-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .setting-group label {
        font-weight: bold;
        font-size: 0.9rem;
        color: #555;
      }

      /* å ´åœ°å¡ç‰‡æ¨£å¼ */
      .court-card {
        background: #eef7ff;
        border-left: 5px solid var(--accent);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #ddecff;
      }
      .court-header {
        font-weight: bold;
        color: var(--accent);
        margin-bottom: 10px;
        border-bottom: 1px solid #bcd;
        padding-bottom: 5px;
        display: flex;
        justify-content: space-between;
      }
      .match-display {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 10px;
        text-align: center;
        font-size: 1.1rem;
        margin: 10px 0;
      }
      .scorer-info {
        background: #fff;
        border: 1px solid #eee;
        padding: 5px;
        border-radius: 4px;
        font-size: 0.9rem;
        text-align: center;
        color: #555;
      }
      .btn-finish {
        background: var(--success);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 6px;
        width: 100%;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .rest-box {
        background: #fff3e0;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ffe0b2;
        margin-top: 20px;
      }
      .stats-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
        margin-top: 10px;
      }
      .stats-table th,
      .stats-table td {
        border: 1px solid #ddd;
        padding: 6px 2px;
        text-align: center;
      }
      .status-on {
        color: var(--success);
        font-weight: bold;
      }
      .status-off {
        color: #999;
      }
      .status-scoring {
        color: #f39c12; /* æ©˜è‰² */
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="title">ğŸ¸ ç¾½çƒæ’å ´ç³»çµ±</h1>

      <div id="setupView">
        <details open>
          <summary>ğŸ‘¥ çƒå“¡ç®¡ç† (<span id="pCount">0</span>äºº)</summary>
          <div class="input-group">
            <div class="row">
              <select id="pSelect" onchange="toggleCustom(this)">
                <option value="">é¸æ“‡äººå“¡...</option>
                <option value="Apple">Apple</option>
                <option value="Bonnie">Bonnie</option>
                <option value="Chloe">Chloe</option>
                <option value="Jamie">Jamie</option>
                <option value="Momo">Momo</option>
                <option value="Nora">Nora</option>
                <option value="Reno">Reno</option>
                <option value="Richard">Richard</option>
                <option value="Sally">Sally</option>
                <option value="Sam">Sam</option>
                <option value="Sasha">Sasha</option>
                <option value="Vivian">Vivian</option>
                <option value="å°ç”«">å°ç”«</option>
                <option value="å°ç”«å‹ï¼ˆè€æ›¹ï¼‰">å°ç”«å‹ï¼ˆè€æ›¹ï¼‰</option>
                <option value="å°ç”«å‹ï¼ˆé­šä¸¸ï¼‰">å°ç”«å‹ï¼ˆé­šä¸¸ï¼‰</option>
                <option value="_custom_">å…¶ä»–äººå“¡ (æ‰‹å‹•è¼¸å…¥)</option>
              </select>
              <input
                type="text"
                id="cInput"
                placeholder="è«‹è¼¸å…¥å§“å"
                style="display: none"
              />
              <button
                id="backBtn"
                class="btn-back"
                style="display: none"
                onclick="resetUI()"
              >
                â† è¿”å›
              </button>
            </div>
            <button class="btn-add" onclick="addPlayer()">ï¼‹ åŠ å…¥çƒå“¡</button>
          </div>

          <div class="player-pool" id="pPool"></div>

          <div class="setting-row">
            <div class="setting-group">
              <label for="courtQty">å ´åœ°æ•¸</label>
              <input type="number" id="courtQty" value="2" min="1" />
            </div>
            <div class="setting-group">
              <label for="maxOn">æœ€é«˜é€£çºŒä¸Šå ´æ¬¡æ•¸</label>
              <input type="number" id="maxOn" value="2" min="1" />
            </div>
          </div>
        </details>
        <button
          onclick="initSystem()"
          style="
            background: var(--accent);
            width: 100%;
            padding: 15px;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 10px;
          "
        >
          ğŸš€ åˆå§‹åŒ–ä¸¦é–‹å§‹æŠ½ç±¤
        </button>
      </div>

      <div id="mainView" style="display: none">
        <div id="courtsArea"></div>

        <div class="rest-box">
          <strong>â˜• ä¼‘æ¯å€ (ä¾é€£ä¼‘é•·çŸ­æ’åº)ï¼š</strong>
          <div id="waitingArea" style="margin-top: 8px"></div>
        </div>

        <table class="stats-table">
          <thead>
            <tr>
              <th>çƒå“¡</th>
              <th>å·²æ‰“</th>
              <th>é€£ä¸Š</th>
              <th>é€£ä¼‘</th>
              <th>ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody id="pStats"></tbody>
        </table>

        <button
          onclick="location.reload()"
          style="
            background: var(--danger);
            width: 100%;
            padding: 10px;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.8rem;
          "
        >
          çµæŸç•¶å‰æ‰€æœ‰å ´æ¬¡ä¸¦é‡ç½®
        </button>
      </div>
    </div>

    <script>
      let names = [
        "å°ç”«",
        "Richard",
        "Sasha",
        "Momo",
        "Nora",
        "Bonnie",
        "Apple",
        "Vivian",
        "Sam",
        "Reno",
        "Sally",
        "Chloe",
      ];
      let players = [];
      let courts = [];

      window.onload = () => updatePool();

      function toggleCustom(s) {
        if (s.value === "_custom_") {
          s.style.display = "none";
          document.getElementById("cInput").style.display = "block";
          document.getElementById("backBtn").style.display = "flex";
          document.getElementById("cInput").focus();
        }
      }

      function resetUI() {
        const s = document.getElementById("pSelect");
        s.style.display = "block";
        s.value = "";
        document.getElementById("cInput").style.display = "none";
        document.getElementById("backBtn").style.display = "none";
      }

      function addPlayer() {
        const sel = document.getElementById("pSelect");
        const inp = document.getElementById("cInput");
        let n = inp.style.display === "block" ? inp.value.trim() : sel.value;
        if (n && !names.includes(n)) {
          names.push(n);
          if (inp.style.display === "block") inp.value = "";
          updatePool();
        }
      }

      function delPlayer(n) {
        names = names.filter((i) => i !== n);
        updatePool();
      }

      function updatePool() {
        document.getElementById("pCount").innerText = names.length;
        // æŒ‰ç…§è‹±æ–‡/ä¸­æ–‡æ’åº
        const sortedNames = [...names].sort((a, b) =>
          a.localeCompare(b, "zh-Hans-TW")
        );

        document.getElementById("pPool").innerHTML = sortedNames
          .map(
            (n) => `
            <div class="tag">${n}<button class="btn-del" onclick="delPlayer('${n}')">Ã—</button></div>
        `
          )
          .join("");
      }

      function initSystem() {
        const cQty = parseInt(document.getElementById("courtQty").value);
        if (names.length < cQty * 5)
          return alert(`äººæ•¸ä¸è¶³ï¼${cQty}å ´éœ€è‡³å°‘ ${cQty * 5} äºº`);

        players = names.map((n) => ({
          name: n,
          played: 0,
          onStreak: 0,
          restStreak: 0,
          status: "idle",
        }));
        courts = Array.from({ length: cQty }, (_, i) => ({
          id: i + 1,
          users: [],
        }));

        document.getElementById("setupView").style.display = "none";
        document.getElementById("mainView").style.display = "block";
        document.getElementById("title").innerText = "ğŸ¾ æ¯”è³½èª¿åº¦ä¸­";

        courts.forEach((c) => drawCourt(c.id));
        render();
      }

      function drawCourt(cId) {
        const court = courts.find((c) => c.id === cId);
        const maxOn = parseInt(document.getElementById("maxOn").value);

        let available = players.filter(
          (p) => p.status === "idle" && p.onStreak < maxOn
        );
        if (available.length < 5) {
          available = players.filter((p) => p.status === "idle");
        }

        available.sort(
          (a, b) => b.restStreak - a.restStreak || a.played - b.played
        );

        const selected = available.slice(0, 5);
        if (selected.length < 5) return;

        selected.forEach((p, index) => {
          p.restStreak = 0;
          if (index < 4) {
            p.status = "playing"; // çƒå“¡ç‹€æ…‹
            p.played++;
            p.onStreak++;
          } else {
            p.status = "scoring"; // è¨˜åˆ†å“¡ç‹€æ…‹
            // p.onStreak = 0; // è‹¥å¸Œæœ›è¨˜åˆ†å“¡ä¸‹ä¸€å ´å„ªå…ˆæ‰“çƒï¼Œå¯è§£é™¤æ­¤è¨»è§£
          }
        });

        court.users = selected;
      }

      function finishCourt(cId) {
        const court = courts.find((c) => c.id === cId);
        players.forEach((p) => {
          if (p.status === "idle") {
            p.restStreak++;
            p.onStreak = 0;
          }
        });
        court.users.forEach((p) => {
          p.status = "idle";
        });
        court.users = [];
        drawCourt(cId);
        render();
      }

      function render() {
        // 2. ç§»é™¤å¤šé¤˜çš„ "æ¯”è³½ä¸­" æ–‡å­—æ¨™ç±¤
        document.getElementById("courtsArea").innerHTML = courts
          .map(
            (c) => `
            <div class="court-card">
                <div class="court-header">ğŸ“ å ´åœ° ${c.id}</div>
                <div class="match-display">
                    <div><b>${c.users[0].name}</b><br><b>${c.users[1].name}</b></div>
                    <div style="color:#aaa; font-style:italic;">VS</div>
                    <div><b>${c.users[2].name}</b><br><b>${c.users[3].name}</b></div>
                </div>
                <div class="scorer-info">ğŸ“‹ è¨˜åˆ†ï¼š${c.users[4].name}</div>
                <button class="btn-finish" onclick="finishCourt(${c.id})">âœ… æ­¤å ´çµæŸ (æ›ä¸‹ä¸€çµ„)</button>
            </div>
        `
          )
          .join("");

        const waiters = players
          .filter((p) => p.status === "idle")
          .sort((a, b) => b.restStreak - a.restStreak);
        document.getElementById("waitingArea").innerHTML = waiters
          .map(
            (p) =>
              `<span class="tag" style="background:#fff;">${p.name} (ä¼‘${p.restStreak})</span>`
          )
          .join(" ");

        // åœ¨ render() å‡½å¼çš„è¡¨æ ¼ç”Ÿæˆéƒ¨åˆ†ä¿®æ”¹å¦‚ä¸‹ï¼š
        document.getElementById("pStats").innerHTML = players
          .map((p) => {
            let statusText = "ä¼‘æ¯";
            let statusClass = "status-off";

            if (p.status === "playing") {
              statusText = "ğŸ¸ ä¸Šå ´";
              statusClass = "status-on";
            } else if (p.status === "scoring") {
              statusText = "ğŸ“‹ è¨ˆåˆ†ä¸­";
              statusClass = "status-scoring"; // ç¨å¾Œåœ¨ CSS åŠ å…¥æ­¤æ¨£å¼
            }

            return `
        <tr>
            <td>${p.name}</td>
            <td>${p.played}</td>
            <td>${p.onStreak}</td>
            <td>${p.restStreak}</td>
            <td class="${statusClass}">${statusText}</td>
        </tr>`;
          })
          .join("");
      }
    </script>
  </body>
</html>
