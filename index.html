<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no,viewport-fit=cover"
    />
    <title>ç¾½çƒåˆ†çµ„ç³»çµ± (æ¬Šé‡å„ªåŒ–ç‰ˆ)</title>
    <style>
      /* ä¿æŒæ‚¨åŸæœ‰çš„ CSS æ¨£å¼ä¸è®Š */
      :root {
        --primary: #2c3e50;
        --accent: #3498db;
        --success: #27ae60;
        --danger: #e74c3c;
        --light: #f8f9fa;
        --warning: #f39c12;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        touch-action: manipulation;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 12px;
        font-size: 14px;
        color: #333;
      }
      .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }
      h1 {
        text-align: center;
        font-size: 1.6rem;
        margin: 10px 0 25px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
        padding: 15px;
        background: var(--light);
        border-radius: 10px;
        border: 1px solid #e1e4e8;
      }
      .row {
        display: flex;
        gap: 10px;
        width: 100%;
        align-items: center;
      }
      select,
      input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px !important;
        background: white;
      }
      .btn-back {
        background: #95a5a6;
        color: white;
        border: none;
        padding: 0 12px;
        border-radius: 8px;
        cursor: pointer;
        height: 48px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        flex-shrink: 0;
      }
      .btn-add {
        background: var(--primary);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        font-weight: bold;
      }
      .player-pool {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 10px;
        margin-bottom: 20px;
        min-height: 120px;
        max-height: 200px;
        overflow-y: auto;
      }
      .tag {
        background: #f0f7ff;
        border: 1px solid #d1e9ff;
        padding: 6px 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.95rem;
      }
      .btn-del {
        color: var(--danger);
        background: none;
        border: none;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
      }
      .setting-row {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 15px;
      }
      .setting-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .setting-group label {
        font-weight: bold;
        color: #444;
      }
      .court-card {
        background: #fbfdff;
        border: 1px solid #ddecff;
        border-top: 6px solid var(--accent);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .court-header {
        font-weight: bold;
        color: var(--accent);
        font-size: 1.1rem;
        margin-bottom: 15px;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 10px;
      }
      .match-display {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 15px;
        text-align: center;
        font-size: 1.2rem;
        margin: 15px 0;
      }
      .team b {
        color: var(--primary);
        display: block;
        line-height: 1.4;
      }
      .btn-finish {
        background: var(--success);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 8px;
        width: 100%;
        font-weight: bold;
        cursor: pointer;
        margin-top: 15px;
        font-size: 1rem;
      }
      .rest-box {
        background: #fff3e0;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ffe0b2;
        margin-top: 25px;
      }
      .waiting-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
      }
      .waiting-tag {
        background: white;
        padding: 5px 10px;
        border-radius: 6px;
        border: 1px solid #ffd180;
        font-size: 0.9rem;
      }
      .stats-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }
      .stats-table th {
        background: #f8f9fa;
        padding: 12px 5px;
        border-bottom: 2px solid #dee2e6;
      }
      .stats-table td {
        padding: 12px 5px;
        border: 1px solid #ddd;
        text-align: center;
      }
      .status-on {
        color: var(--success);
        font-weight: bold;
      }
      .status-off {
        color: #abb5be;
      }
      .btn-start {
        background: var(--accent);
        width: 100%;
        padding: 18px;
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.2rem;
        margin-top: 10px;
      }
      .btn-reset {
        background: #f8f9fa;
        color: var(--danger);
        border: 1px solid var(--danger);
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        margin-top: 30px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="title">ğŸ¸ ç¾½çƒåˆ†çµ„ç³»çµ±</h1>

      <div id="setupView">
        <details open>
          <summary style="font-weight: bold; cursor: pointer; padding: 5px 0">
            ğŸ‘¥ çƒå“¡ç®¡ç† (<span id="pCount">0</span>äºº)
          </summary>
          <div class="input-group">
            <div class="row">
              <select id="pSelect" onchange="toggleCustom(this)">
                <option value="">é¸æ“‡äººå“¡...</option>
                <option value="Apple">Apple</option>
                <option value="Bonnie">Bonnie</option>
                <option value="Chloe">Chloe</option>
                <option value="Jamie">Jamie</option>
                <option value="Momo">Momo</option>
                <option value="Nora">Nora</option>
                <option value="Reno">Reno</option>
                <option value="Richard">Richard</option>
                <option value="Sally">Sally</option>
                <option value="Sam">Sam</option>
                <option value="Sasha">Sasha</option>
                <option value="Vivian">Vivian</option>
                <option value="å°ç”«">å°ç”«</option>
                <option value="_custom_">å…¶ä»–äººå“¡ (æ‰‹å‹•è¼¸å…¥)</option>
              </select>
              <input
                type="text"
                id="cInput"
                placeholder="è«‹è¼¸å…¥å§“å"
                style="display: none"
              />
              <button
                id="backBtn"
                class="btn-back"
                style="display: none"
                onclick="resetUI()"
              >
                â† è¿”å›
              </button>
            </div>
            <button class="btn-add" onclick="addPlayer()">ï¼‹ åŠ å…¥åå–®</button>
          </div>
          <div class="player-pool" id="pPool"></div>
          <button
            class="btn-reset"
            style="
              margin-top: 0;
              margin-bottom: 20px;
              border-color: #ccc;
              color: #666;
            "
            onclick="clearAllNames()"
          >
            ğŸ—‘ï¸ æ¸…ç©ºæˆå“¡åå–®
          </button>
          <div class="setting-row">
            <div class="setting-group">
              <label for="courtQty">å ´åœ°æ•¸</label>
              <input type="number" id="courtQty" value="2" min="1" />
            </div>
          </div>
        </details>
        <button onclick="initSystem()" class="btn-start">
          ğŸš€ é–‹å§‹åˆ†çµ„æŠ½ç±¤
        </button>
      </div>

      <div id="mainView" style="display: none">
        <div id="courtsArea"></div>
        <div class="rest-box">
          <strong>â˜• ä¼‘æ¯åå–® (å„ªå…ˆä¸Šå ´æ’åº)ï¼š</strong>
          <div id="waitingArea" class="waiting-list"></div>
        </div>
        <table class="stats-table">
          <thead>
            <tr>
              <th>çƒå“¡</th>
              <th>ç¸½å ´æ•¸</th>
              <th>é€£ä¸Š</th>
              <th>é€£ä¼‘</th>
              <th>ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody id="pStats"></tbody>
        </table>
        <button onclick="location.reload()" class="btn-reset">
          çµæŸæ´»å‹•ä¸¦é‡ç½®æ•¸æ“š
        </button>
      </div>
    </div>

    <script>
      let names =
        JSON.parse(localStorage.getItem("badminton_names_simple")) || [];
      let players = [];
      let courts = [];

      window.onload = () => updatePool();

      function saveToLocal() {
        localStorage.setItem("badminton_names_simple", JSON.stringify(names));
      }
      function toggleCustom(s) {
        if (s.value === "_custom_") {
          s.style.display = "none";
          document.getElementById("cInput").style.display = "block";
          document.getElementById("backBtn").style.display = "block";
          document.getElementById("cInput").focus();
        }
      }
      function resetUI() {
        const s = document.getElementById("pSelect");
        s.style.display = "block";
        s.value = "";
        document.getElementById("cInput").style.display = "none";
        document.getElementById("backBtn").style.display = "none";
      }
      function addPlayer() {
        const sel = document.getElementById("pSelect");
        const inp = document.getElementById("cInput");
        let n = inp.style.display === "block" ? inp.value.trim() : sel.value;
        if (n && !names.includes(n)) {
          names.push(n);
          if (inp.style.display === "block") inp.value = "";
          saveToLocal();
          updatePool();
        }
      }
      function delPlayer(n) {
        names = names.filter((i) => i !== n);
        saveToLocal();
        updatePool();
      }
      function updatePool() {
        document.getElementById("pCount").innerText = names.length;
        document.getElementById("pPool").innerHTML = [...names]
          .sort((a, b) => a.localeCompare(b, "zh-TW"))
          .map(
            (n) =>
              `<div class="tag">${n}<button class="btn-del" onclick="delPlayer('${n}')">Ã—</button></div>`,
          )
          .join("");
      }

      function initSystem() {
        const cQty = parseInt(document.getElementById("courtQty").value);
        if (names.length < 4 * cQty)
          return alert(`äººæ•¸ä¸è¶³ï¼${cQty} å€‹å ´åœ°è‡³å°‘éœ€è¦ ${4 * cQty} äºº`);

        players = names.map((n) => ({
          name: n,
          played: 0,
          onStreak: 0,
          restStreak: 0,
          status: "idle",
          history: {},
        }));

        courts = Array.from({ length: cQty }, (_, i) => ({
          id: i + 1,
          users: [],
        }));
        document.getElementById("setupView").style.display = "none";
        document.getElementById("mainView").style.display = "block";
        document.getElementById("title").innerText = "ğŸ¸ æ’å ´ç³»çµ±é‹ä½œä¸­";
        drawGroups(true);
      }

      function pickPlayersForCourt(count) {
        let selected = [];
        // é€™è£¡åªéæ¿¾æ‰ã€Œå·²ç¶“è¢«æœ¬è¼ªé¸ä¸­å ´åœ°ã€çš„äºº
        let pool = players.filter((p) => !p.tempPicked);

        console.log(`--- âš–ï¸ æ¬Šé‡è¨ˆç®— (æŒ‘é¸ ${count} äºº) ---`);

        for (let i = 0; i < count; i++) {
          if (pool.length === 0) break;

          let candidates = pool.map((p) => {
            let baseRand = Math.random() * 150; // ç¨å¾®èª¿ä½éš¨æ©Ÿå½±éŸ¿
            let restScore = p.restStreak * 70;
            let onStreakScore = -(p.onStreak * 120); // å¤§å¹…æé«˜é€£æ‰“æ‡²ç½°
            let playedScore = -(p.played * 30);
            let guaranteeScore =
              p.restStreak >= 3 ? 5000 + p.restStreak * 100 : 0;

            let historyPenalty = 0;
            selected.forEach((s) => {
              let metTimes = p.history[s.name] || 0;
              historyPenalty -= metTimes * 150;
            });

            let finalScore =
              baseRand +
              restScore +
              onStreakScore +
              playedScore +
              guaranteeScore +
              historyPenalty;

            return {
              name: p.name,
              player: p,
              finalScore: finalScore,
              detail: `éš¨æ©Ÿ:${baseRand.toFixed(0)}, ä¼‘:${restScore}, é€£æ‰“ç½°:${onStreakScore}, ä¿é€:${guaranteeScore}, å°æˆ°ç½°:${historyPenalty}`,
            };
          });

          candidates.sort((a, b) => b.finalScore - a.finalScore);
          let picked = candidates[0].player;
          picked.tempPicked = true; // æ¨™è¨˜ç‚ºæœ¬è¼ªå·²é¸ä¸­

          selected.push(picked);
          pool = pool.filter((p) => p !== picked);
        }
        return selected;
      }

      function drawGroups(isWholeRefresh) {
        // é‡ç½®æœ¬è¼ªæŒ‘é¸æ¨™è¨˜
        players.forEach((p) => (p.tempPicked = false));

        if (isWholeRefresh) {
          // å…¨å ´é‡æŠ½æ™‚ï¼ŒåŸæœ¬çš„äººè¦–ç‚ºã€Œå‰›å¾å ´ä¸Šä¸‹ä¾†ã€ä»¥ç¶­æŒé€£æ‰“è¨ˆç®—
          courts.forEach((c) => {
            let newUsers = pickPlayersForCourt(4);
            // å…ˆæš«å­˜æ–°åå–®ï¼Œä¸ç›´æ¥è¦†è“‹ï¼Œé¿å… updateStats æŠ“ä¸åˆ°èˆŠç‹€æ…‹
            c.nextUsers = newUsers;
          });

          // æ›´æ–°åå–®
          courts.forEach((c) => {
            c.users = c.nextUsers;
            delete c.nextUsers;
          });
        }

        updateStats();
        render();
      }

      function finishOneCourt(cId) {
        players.forEach((p) => (p.tempPicked = false));
        const court = courts.find((c) => c.id === cId);

        // æ¨™è¨˜å…¶ä»–çƒå ´æ­£åœ¨æ‰“çš„äººï¼Œè®“ä»–å€‘ä¸èƒ½è¢«é¸ä¸­
        courts.forEach((c) => {
          if (c.id !== cId) {
            c.users.forEach((u) => {
              let p = players.find((pl) => pl.name === u.name);
              if (p) p.tempPicked = true;
            });
          }
        });

        let nextUsers = pickPlayersForCourt(4);
        if (nextUsers.length < 4) return alert("å¯ç”¨çƒå“¡ä¸è¶³ï¼");

        court.users = nextUsers;
        updateStats();
        render();
      }

      function updateStats() {
        const allOnCourtNames = courts.flatMap((c) =>
          c.users.map((u) => u.name),
        );

        // 1. æ›´æ–°å°æˆ°æ­·å²
        courts.forEach((c) => {
          if (c.users.length === 4) {
            c.users.forEach((p) => {
              c.users.forEach((target) => {
                if (p.name !== target.name) {
                  p.history[target.name] = (p.history[target.name] || 0) + 1;
                }
              });
            });
          }
        });

        // 2. æ›´æ–°ç‹€æ…‹èˆ‡é€£æ‰“æ¬¡æ•¸ (é—œéµä¿®å¾©)
        players.forEach((p) => {
          const isNowPlaying = allOnCourtNames.includes(p.name);

          if (isNowPlaying) {
            if (p.status === "playing") {
              p.onStreak++; // çœŸçš„é€£æ‰“äº†
            } else {
              p.onStreak = 1; // å‰›ä¸Šå ´
            }
            p.played++;
            p.restStreak = 0;
            p.status = "playing";
          } else {
            p.onStreak = 0;
            p.restStreak++;
            p.status = "idle";
          }
          p.tempPicked = false; // æ¸…é™¤æš«å­˜æ¨™è¨˜
        });
      }

      function render() {
        let html = courts
          .map((c) => {
            if (c.users.length < 4)
              return `<div class="court-card">ğŸ“ å ´åœ° ${c.id}<br>äººæ•¸ä¸è¶³</div>`;
            const btn = `<button class="btn-finish" onclick="finishOneCourt(${c.id})">âœ… çµæŸä¸¦æ›äºº</button>`;
            let d = [...c.users];
            return `
        <div class="court-card">
          <div class="court-header">ğŸ“ å ´åœ° ${c.id}</div>
          <div class="match-display">
            <div class="team"><b>${d[0].name}</b><b>${d[1].name}</b></div>
            <div style="color:#aaa; font-style:italic;">VS</div>
            <div class="team"><b>${d[2].name}</b><b>${d[3].name}</b></div>
          </div>
          ${btn}
        </div>`;
          })
          .join("");

        if (players.length > 0) {
          html += `<button class="btn-start" style="background:#66cf36; margin-bottom:20px;" onclick="drawGroups(true)">ğŸ”„ å…¨å ´æ‰“äº‚é‡æŠ½</button>`;
        }

        document.getElementById("courtsArea").innerHTML = html;
        document.getElementById("waitingArea").innerHTML =
          players
            .filter((p) => p.status === "idle")
            .sort((a, b) => b.restStreak - a.restStreak)
            .map(
              (p) =>
                `<span class="waiting-tag">${p.name} <small>(ä¼‘${p.restStreak})</small></span>`,
            )
            .join("") || "ç„¡";

        document.getElementById("pStats").innerHTML = players
          .sort((a, b) => b.played - a.played || b.restStreak - a.restStreak)
          .map((p) => {
            let sClass = p.status === "playing" ? "status-on" : "status-off";
            let sText = p.status === "playing" ? "ğŸ¸ ä¸Šå ´" : "ä¼‘æ¯";
            return `<tr><td>${p.name}</td><td>${p.played}</td><td>${p.onStreak}</td><td>${p.restStreak}</td><td class="${sClass}">${sText}</td></tr>`;
          })
          .join("");
      }

      function clearAllNames() {
        if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æˆå“¡åå–®å—ï¼Ÿ")) {
          names = [];
          saveToLocal();
          updatePool();
        }
      }
    </script>
  </body>
</html>
